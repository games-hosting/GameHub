<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>???</title>
  <link rel="icon" href="https://ssl.gstatic.com/classroom/favicon.ico" type="image/x-icon">
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: linear-gradient(to bottom, #0a0a0a, #1a0033);
      font-family: 'Orbitron', monospace;
      color: #00ffff;
      height: 100vh;
      touch-action: none;
      user-select: none;
    }
    /* MAIN MENU */
    #mainMenu {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    #mainMenu h1 {
      font-size: 5em;
      margin-bottom: 50px;
      text-shadow: 0 0 30px #ff00ff;
      color: #ff00ff;
    }
    .menuBtn {
      margin: 15px;
      padding: 25px 80px;
      font-size: 2.5em;
      background: linear-gradient(45deg, #00ffff, #ff00ff);
      color: #000;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-family: 'Orbitron', monospace;
      font-weight: bold;
      transition: transform 0.2s;
    }
    .menuBtn:hover {
      transform: scale(1.1);
    }
    .menuBtn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    /* CUTSCENES */
    .cutscene {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.95);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 40px;
      text-align: center;
    }
    .cutscene h1 {
      font-size: 3.5em;
      margin-bottom: 30px;
      color: #ff00ff;
      text-shadow: 0 0 20px #ff00ff;
    }
    .cutscene p {
      font-size: 2em;
      max-width: 800px;
      line-height: 1.5;
      margin-bottom: 40px;
      color: #00ffff;
    }
    .cutscene button {
      padding: 20px 60px;
      font-size: 2em;
      background: linear-gradient(45deg, #00ffff, #ff00ff);
      color: #000;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-family: 'Orbitron', monospace;
      font-weight: bold;
    }
    /* SHARED GAME ELEMENTS */
    #gameOver, #win, #chapterWin {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 20;
      color: #ff00ff;
    }
    #gameOver h1, #win h1, #chapterWin h1 {
      font-size: 4em;
      margin: 0;
    }
    .restart {
      margin-top: 30px;
      padding: 20px 60px;
      font-size: 2em;
      background: linear-gradient(45deg, #00ffff, #ff00ff);
      color: #000;
      border: none;
      border-radius: 50px;
      cursor: pointer;
    }
    #backToMenu {
      margin-top: 15px;
      padding: 15px 40px;
      font-size: 1.5em;
      background: #444;
      color: #fff;
      border: none;
      border-radius: 30px;
      cursor: pointer;
    }
    /* CHAPTER 1 - RED LIGHT GREEN LIGHT (unchanged, phase 1 fine) */
    #chapter1 {
      position: relative;
      width: 100%;
      height: 100%;
      display: none;
    }
    /* CHAPTER 5 - FINAL BOSS (harder version) */
    #chapter5 {
      position: relative;
      width: 100%;
      height: 100%;
      display: none;
    }
    #bossCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom, #2d1b69, #0f0f23);
    }
    #bossUI {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 5;
    }
    #bossStatus {
      font-size: 2.5em;
      color: #ff00ff;
      text-shadow: 0 0 10px #ff00ff;
      margin-bottom: 10px;
    }
    #phaseDisplay, #livesDisplay {
      font-size: 1.8em;
      color: #00ffff;
      text-shadow: 0 0 10px #00ffff;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <!-- MAIN MENU -->
  <div id="mainMenu">
    <h1>ESCAPE MORGAN</h1>
    <button class="menuBtn" id="ch1Btn" onclick="startChapter1()">CHAPTER 1</button>
    <button class="menuBtn" id="ch5Btn" onclick="startChapter5()">FINAL BOSS</button>
  </div>

  <!-- CHAPTER 5 - FINAL BOSS -->
  <div id="chapter5">
    <canvas id="bossCanvas"></canvas>
    <div id="bossUI">
      <div id="bossStatus">SURVIVE ALL 3 PHASES!</div>
      <div id="phaseDisplay">PHASE: <span id="phaseNumber">1</span>/3</div>
      <div id="livesDisplay">LIVES: <span id="livesCount">3</span></div>
    </div>
    <div id="chapter5Win">
      <h1>MORGAN DEFEATED!</h1>
      <p>YOU ARE THE CHAMPION!</p>
      <button class="restart" onclick="goToMenu()">BACK TO MENU</button>
    </div>
    <div id="gameOver">
      <h1>MORGAN WINS!</h1>
      <button class="restart" onclick="resetChapter5()">TRY AGAIN</button>
      <button id="backToMenu" onclick="goToMenu()">BACK TO MENU</button>
    </div>
  </div>

  <script>
    // ========== NAVIGATION ==========
    function goToMenu() {
      document.getElementById('mainMenu').style.display = 'flex';
      document.getElementById('chapter5').style.display = 'none';
      stopChapter5();
    }

    function startChapter5() {
      document.getElementById('mainMenu').style.display = 'none';
      document.getElementById('chapter5').style.display = 'block';
      resetChapter5();
    }

    // ========== CHAPTER 5: FINAL BOSS - HARDER VERSION ==========
    const bossCanvas = document.getElementById('bossCanvas');
    const bossCtx = bossCanvas ? bossCanvas.getContext('2d') : null;
    const phaseNumber = document.getElementById('phaseNumber');
    const livesCount = document.getElementById('livesCount');
    const chapter5Win = document.getElementById('chapter5Win');
    const gameOver = document.getElementById('gameOver');
    let ch5Running = false;
    let ch5AnimationFrame = null;
    let ch5PlayerX = 0;
    let ch5PlayerY = 0;
    let phase = 1;
    let lives = 3;
    let projectiles = [];
    let phaseTimer = 0;
    let morganPositions = []; // for phase 3
    let morganCount = 1; // starts with 1, becomes 3 in phase 3

    function resizeBossCanvas() {
      if (!bossCanvas) return;
      bossCanvas.width = window.innerWidth;
      bossCanvas.height = window.innerHeight;
      ch5PlayerX = bossCanvas.width / 2;
      ch5PlayerY = bossCanvas.height - 100;
    }

    function resetChapter5() {
      if (!bossCanvas) return;
      resizeBossCanvas();
      ch5Running = true;
      ch5PlayerX = bossCanvas.width / 2;
      ch5PlayerY = bossCanvas.height - 100;
      phase = 1;
      lives = 3;
      projectiles = [];
      phaseTimer = 0;
      morganPositions = [{x: bossCanvas.width / 2, y: 100}];
      morganCount = 1;
      chapter5Win.style.display = 'none';
      gameOver.style.display = 'none';
      phaseNumber.textContent = phase;
      livesCount.textContent = lives;
      gameLoopChapter5();
    }

    function spawnProjectile(fromX, fromY) {
      const angle = Math.atan2(ch5PlayerY - fromY, ch5PlayerX - fromX) + (Math.random() - 0.5) * 0.3;
      projectiles.push({
        x: fromX,
        y: fromY,
        vx: Math.cos(angle) * (4 + phase * 0.5),
        vy: Math.sin(angle) * (4 + phase * 0.5)
      });
    }

    function gameLoopChapter5() {
      if (!ch5Running) return;
      bossCtx.fillStyle = phase === 1 ? '#1a0033' : phase === 2 ? '#330011' : '#110033';
      bossCtx.fillRect(0, 0, bossCanvas.width, bossCanvas.height);

      // Player movement
      const moveSpeed = 6;
      if (keys['ArrowLeft'] || keys['a']) ch5PlayerX -= moveSpeed;
      if (keys['ArrowRight'] || keys['d']) ch5PlayerX += moveSpeed;
      if (keys['ArrowUp'] || keys['w']) ch5PlayerY -= moveSpeed;
      if (keys['ArrowDown'] || keys['s']) ch5PlayerY += moveSpeed;
      ch5PlayerX = Math.max(30, Math.min(bossCanvas.width - 30, ch5PlayerX));
      ch5PlayerY = Math.max(30, Math.min(bossCanvas.height - 30, ch5PlayerY));

      // Draw player
      bossCtx.fillStyle = '#00ffff';
      bossCtx.font = '50px Arial';
      bossCtx.fillText('ðŸƒ', ch5PlayerX - 25, ch5PlayerY + 25);

      // Phase progression
      phaseTimer++;
      if (phaseTimer > 900) { // ~15 sec per phase
        phase++;
        phaseTimer = 0;
        projectiles = [];
        if (phase === 2) {
          // Phase 2: smaller lights + bullets
          morganCount = 1;
        } else if (phase === 3) {
          // Phase 3: 3 Morgans, double bullets
          morganCount = 3;
          morganPositions = [
            {x: bossCanvas.width * 0.3, y: 100},
            {x: bossCanvas.width / 2, y: 100},
            {x: bossCanvas.width * 0.7, y: 100}
          ];
        }
      }

      // Spawn projectiles based on phase
      if (phaseTimer % (60 - phase * 10) === 0) {
        morganPositions.forEach(m => {
          // Double bullets in phase 3
          const bulletCount = phase === 3 ? 2 : 1;
          for (let i = 0; i < bulletCount; i++) {
            spawnProjectile(m.x, m.y);
          }
        });
      }

      // Update and draw projectiles
      projectiles.forEach((proj, idx) => {
        proj.x += proj.vx;
        proj.y += proj.vy;

        bossCtx.fillStyle = '#ff0000';
        bossCtx.beginPath();
        bossCtx.arc(proj.x, proj.y, 10, 0, Math.PI * 2);
        bossCtx.fill();

        const dist = Math.sqrt((proj.x - ch5PlayerX) ** 2 + (proj.y - ch5PlayerY) ** 2);
        if (dist < 30) {
          lives--;
          projectiles.splice(idx, 1);
          livesCount.textContent = lives;
          if (lives <= 0) {
            ch5Running = false;
            gameOver.style.display = 'flex';
            return;
          }
        }

        if (proj.x < 0 || proj.x > bossCanvas.width || proj.y < 0 || proj.y > bossCanvas.height) {
          projectiles.splice(idx, 1);
        }
      });

      // Draw Morgans
      morganPositions.forEach(m => {
        bossCtx.fillStyle = '#ff00ff';
        bossCtx.font = '80px Arial';
        bossCtx.fillText('ðŸ˜ˆ', m.x - 40, m.y);
      });

      phaseNumber.textContent = phase;

      ch5AnimationFrame = requestAnimationFrame(gameLoopChapter5);
    }

    window.addEventListener('resize', () => {
      if (ch5Running) resizeBossCanvas();
    });

    restartBtns.forEach(btn => {
      btn.onclick = resetChapter5;
    });

    resetChapter5();
  </script>
</body>
</html>
